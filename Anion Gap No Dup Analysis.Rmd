---
title: "Anion Gap No Dup Analysis"
author: "Tyler Cooke"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## 1. Import data

```{r, echo = FALSE}
library(tidyverse)
library(knitr)
library(ggthemes)
library(ggnewscale)
library(ggridges)

setwd(paste0(getwd(), "/.."))
csv2022 <- read.csv(paste0(
  getwd(), "/00. Data/02. Combined Data/AGAP_0612-082022.csv"
))
csv2023 <- read.csv(paste0(
  getwd(), "/00. Data/02. Combined Data/AGAP_0611-081923.csv"
))
tat2022 <- read.csv(paste0(
  getwd(), "/00. Data/02. Combined Data/TAT_0612-082022.csv"
))
tat2023 <- read.csv(paste0(
  getwd(), "/00. Data/02. Combined Data/TAT_0611-081923.csv"
))
cr2023 <- read.csv(paste0(
  getwd(), "/00. Data/02. Combined Data/Creatinine_0611-081923.csv"
))
cr2022 <- read.csv(paste0(
  getwd(), "/00. Data/02. Combined Data/Creatinine_0612-082022.csv"
))


```

## 2. Clean data, add Location and prePost variables

-   Filter patient location for Emergency, Inpatient, and Outpatient (including "Private Ambulatory")
-   Add Time, Date, and DayOfWeek variables (extracted from PERFORM_DT_TM)

```{r, echo = FALSE}
clean.csv <- function(dataframe) {
  names(dataframe) <- str_replace_all(names(dataframe), "X_", "")
  dataframe$RESULT <- str_trim(dataframe$RESULT, side = "left") %>% 
    as.numeric()
  dataframe <- dataframe %>% 
    filter(!is.na(RESULT)) %>% 
    filter(str_ends(SVCRSC, "C702")) %>% 
    filter(!(CAT == ".BMPP" | CAT == ".CMPP")) %>% 
    filter(ENCTYP == 'Inpatient' |
             ENCTYP == 'Outpatient' |
             ENCTYP == 'Emergency' |
             ENCTYP == 'Private Ambulatory'
    ) %>%
  mutate(
    Location = case_when(
      ENCTYP == 'Inpatient' ~ 'Inpatient',
      ENCTYP == 'Outpatient' ~ 'Outpatient',
      ENCTYP == 'Emergency' ~ 'Emergency',
      ENCTYP == 'Private Ambulatory' ~ 'Outpatient',
    )
  )
  dataframe$Location <- factor(dataframe$Location,
                                levels = c('Outpatient','Emergency','Inpatient'))
  
  return(dataframe)
}

clean.tat <- function(dataframe) {
  names(dataframe) <- str_replace_all(names(dataframe), "\\.\\.\\.", "")
  dataframe <- dataframe %>% 
    filter(
      Accession.NbrFormatted != "---",
      Order.Status == "Completed"
    ) %>% 
    mutate(
      ACC = str_trim(Accession.NbrFormatted, side = "right"),
      Date.TimeOrder = mdy_hm(str_remove_all(Date.TimeOrder, ",")),
      Date.TimeReq.Coll = mdy_hm(str_remove_all(Date.TimeReq.Coll, ",'")),
      Date.TimeDrawn = mdy_hm(str_remove_all(Date.TimeDrawn, ",'")),
      Date.TimeIn.Lab = mdy_hm(str_remove_all(Date.TimeIn.Lab, ",'")),
      Date.TimeComplete = mdy_hm(str_remove_all(Date.TimeComplete, ",'")),
    )
  return(dataframe)
}

clean.cr <- function(dataframe) {
  dataframe <- dataframe[!duplicated(dataframe$ACC),]
  
  names(dataframe) <- paste0("cr_", names(dataframe))
  
  return(dataframe)
}


df.2022 <- clean.csv(csv2022)
df.2023 <- clean.csv(csv2023)

tat.2022 <- clean.tat(tat2022)
tat.2023 <- clean.tat(tat2023)

cr.2022 <- clean.cr(cr2022)
cr.2023 <- clean.cr(cr2023)

days <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")
dates.2022 <- str_sub(df.2022$PERFORM_DT_TM, start = 1, end = 8)
dates.2022 <- dates.2022[!duplicated(dates.2022)]
dateday.2022 <- data.frame(dates.2022, rep(days, length.out = length(dates.2022)))

dates.2023 <- str_sub(df.2023$PERFORM_DT_TM, start = 1, end = 8)
dates.2023 <- dates.2023[!duplicated(dates.2023)]
dateday.2023 <- data.frame(dates.2023, rep(days, length.out = length(dates.2023)))

df.2022 <- df.2022 %>% 
  mutate(
    DayOfWeek = factor(
      dateday.2022[match(str_sub(PERFORM_DT_TM, start = 1, end = 8),
                                   dateday.2022[,1]),2],
      levels = days
      ),
    Time = str_sub(PERFORM_DT_TM, start = 10, end = 11),
    Date = str_sub(PERFORM_DT_TM, start = 1, end = 8)
  )
  

df.2023 <- df.2023 %>% 
  mutate(
    DayOfWeek = factor(
      dateday.2023[match(str_sub(PERFORM_DT_TM, start = 1, end = 8),
                                   dateday.2023[,1]),2],
      levels = days
      ),
    Time = str_sub(PERFORM_DT_TM, start = 10, end = 11),
    Date = str_sub(PERFORM_DT_TM, start = 1, end = 8)
  )

df.2022.rmdup <- df.2022[!duplicated(df.2022$MRN),]
df.2022.rmdup <- df.2022.rmdup[(df.2022.rmdup$ACC %in% tat.2022$ACC),]

df.2023.rmdup <- df.2023[!duplicated(df.2023$MRN),]
df.2023.rmdup <- df.2023.rmdup[(df.2023.rmdup$ACC %in% tat.2023$ACC),]

df.2022.rmdup.wkday <- df.2022.rmdup %>% filter((DayOfWeek != "Saturday") & (DayOfWeek != "Sunday")) 
df.2023.rmdup.wkday <- df.2023.rmdup %>% filter((DayOfWeek != "Saturday") & (DayOfWeek != "Sunday"))

tat.2022.rmdup <- tat.2022 %>% 
  arrange(Date.TimeComplete) %>% 
  filter(!duplicated(ACC))

tat.2023.rmdup <- tat.2023 %>% 
  arrange(Date.TimeComplete) %>% 
  filter(!duplicated(ACC))

df.2022.rmdup.wkday.tat <- merge(
  x = df.2022.rmdup.wkday,
  y = tat.2022.rmdup[c("ACC", "Date.TimeOrder", "Date.TimeReq.Coll", "Date.TimeDrawn", "Date.TimeIn.Lab", "Date.TimeComplete")],
  by.x = "ACC",
  by.y = "ACC"
)

#### Remove the .cr from this later, it was only included for testing purposes. 
df.2022.rmdup.wkday.tat.cr <- merge(
  x = df.2022.rmdup.wkday.tat,
  y = cr.2022[c("cr_ACC", "cr_RESULT", "cr_NORM", "cr_MRN")],
  by.x = "ACC",
  by.y = "cr_ACC"
)

df.2023.rmdup.wkday.tat <- merge(
  x = df.2023.rmdup.wkday,
  y = tat.2023.rmdup[c("ACC", "Date.TimeOrder", "Date.TimeReq.Coll", "Date.TimeDrawn", "Date.TimeIn.Lab", "Date.TimeComplete")],
  by.x = "ACC",
  by.y = "ACC"
)

#### Remove the .cr from this later, it was only included for testing purposes. 
df.2023.rmdup.wkday.tat.cr <- merge(
  x = df.2023.rmdup.wkday.tat,
  y = cr.2023[c("cr_ACC", "cr_RESULT", "cr_NORM", "cr_MRN")],
  by.x = "ACC",
  by.y = "cr_ACC"
)

tatAnalysis <- function(dataframe) {
  output <- dataframe %>% 
    mutate(
      Time.InLab = str_pad(hour(Date.TimeIn.Lab), 2, side = "left", pad = "0"),
      TAT_min = difftime(Date.TimeComplete, Date.TimeIn.Lab, units = "mins"),
      TAT_hrs = as.double(difftime(Date.TimeComplete, Date.TimeIn.Lab, units = "hours"))
    )
  return(output)
}

df.2022.rmdup.wkday.tat <- tatAnalysis(df.2022.rmdup.wkday.tat)
df.2023.rmdup.wkday.tat <- tatAnalysis(df.2023.rmdup.wkday.tat)
```

## 3. Descriptive Statistics

```{r}
descStats <- function(dataframe, title) {
  summaryFunc <- function(dataframe) {
    return(c(
      sapply(
        c(
          length(dataframe$RESULT),
          median(dataframe$RESULT),
          round(mean(dataframe$RESULT), 2),
          round(sd(dataframe$RESULT), 2)
        ),
        as.character
      ),
      paste0(
        as.character(range(dataframe$RESULT))[1],
        " to ",
        as.character(range(dataframe$RESULT))[2]
      )
    ))
  }
  
  output <- data.frame(
    summaryFunc(dataframe),
    summaryFunc(filter(dataframe, Location == "Inpatient")),
    summaryFunc(filter(dataframe, Location == "Emergency")),
    summaryFunc(filter(dataframe, Location == "Outpatient")),
    row.names = c("n", "Median", "Mean", "Std. dev.", "Range")
  )
  names(output) <- c("Overall", "Inpatient", "Emergency", "Outpatient")
  return(output)
}

ds.2022 <- descStats(df.2022.rmdup, "Descriptive Statistics, 2022 data")
ds.2023 <- descStats(df.2023.rmdup, "Descriptive Statistics, 2023 data")

kable(ds.2022)
kable(ds.2023)
```

## 4. Density Plots

```{r}
plot.2022 <- ggplot(df.2022.rmdup.wkday, aes(x = RESULT)) +
  geom_freqpoly(
    color = "red",
    binwidth = 1) +
  labs(title = "Anion Gap Frequency Plot (weekdays)")

overlay.plot <- plot.2022 + 
  geom_freqpoly(
    data = df.2023.rmdup.wkday,
    color = "blue",
    binwidth = 1) +
  annotate("text", x = 30, y = 5000,label = "Red = 2022", color = "red") +
  annotate("text", x = 30, y = 4700, label = "Blue = 2023", color = "blue")
overlay.plot

Inpt22 <- "#e9a0a5"
Emrg22 <- "#c5373d"
Otpt22 <- "#730c0d"
Inpt23 <- "#9bcae9"
Emrg23 <- "#006eae"
Otpt23 <- "#002359"

plot.2022.location <- ggplot(df.2022.rmdup.wkday, aes(x = RESULT)) +
  geom_freqpoly(data = filter(df.2022.rmdup.wkday, Location == "Inpatient"), color = Inpt22, binwidth = 1) +
  geom_freqpoly(data = filter(df.2022.rmdup.wkday, Location == "Emergency"), color = Emrg22, binwidth = 1) +
  geom_freqpoly(data = filter(df.2022.rmdup.wkday, Location == "Outpatient"), color = Otpt22, binwidth = 1) +
  labs(title = "2022 Anion Gap Frequency Plot by Location (weekdays)") +
  theme_minimal()
plot.2022.location +
  annotate(
    "text", x = 30, y = 1500, hjust = 0, lineheight = 1.8,
    label = c("Legend", "\nInpatient", "\n\nEmergency", "\n\n\nOutpatient"),
    color = c("black", Inpt22, Emrg22, Otpt22),
    fontface = c("bold", "plain", "plain", "plain"))

plot.2023.location <- ggplot(df.2023.rmdup.wkday, aes(x = RESULT)) +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday, Location == "Inpatient"), color = Inpt23, binwidth = 1) +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday, Location == "Emergency"), color = Emrg23, binwidth = 1) +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday, Location == "Outpatient"), color = Otpt23, binwidth = 1) +
  labs(title = "2023 Anion Gap Frequency Plot by Location (weekdays)") +
  theme_minimal()
plot.2023.location  +
    annotate(
    "text", x = 30, y = 1500, hjust = 0, lineheight = 1.8,
    label = c("Legend", "\nInpatient", "\n\nEmergency", "\n\n\nOutpatient"),
    color = c("black", Inpt23, Emrg23, Otpt23),
    fontface = c("bold", "plain", "plain", "plain"))

location.overlay <- plot.2022.location + 
    geom_freqpoly(data = filter(df.2023.rmdup.wkday, Location == "Inpatient"), color = Inpt23, binwidth = 1) +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday, Location == "Emergency"), color = Emrg23, binwidth = 1) +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday, Location == "Outpatient"), color = Otpt23, binwidth = 1) + 
  labs(title = "Anion Gap Frequency Plot by Year and Location (weekdays)")
location.overlay +
  annotate(
    "text", x = 30, y = 2750, hjust = 0, lineheight = 1.8,
    label = c("Legend", "\n\n2022", "\n\n\nInpatient", "\n\n\n\nEmergency", "\n\n\n\n\nOutpatient"),
    color = c("black", "black",Inpt22, Emrg22, Otpt22),
    fontface = c("bold", "bold", "plain", "plain", "plain")) +
  annotate(
    "text", x = 30, y = 1500, hjust = 0, lineheight = 1.8,
    label = c("2023", "\nInpatient", "\n\nEmergency", "\n\n\nOutpatient"),
    color = c("black", Inpt23, Emrg23, Otpt23),
    fontface = c("bold", "plain", "plain", "plain"))


dayplot.2022 <- ggplot(df.2022.rmdup, aes(x = DayOfWeek)) +
  geom_bar() +
  labs(title = "2022 Test Count by Day of Week")
print(dayplot.2022)

dayplot.2023 <- ggplot(df.2023.rmdup, aes(x = DayOfWeek)) +
  geom_bar() +
  labs(title = "2023 Test Count by Day of Week")
dayplot.2023

```

## 5. Anion Gap Elevation by Time

```{r, echo = FALSE}
highRateComparison <- function(dataframe1, dataframe2, highlevel) {
  
  by_Time1 <- dataframe1 %>% 
    group_by(Time) %>% 
    summarize(
      High = sum(RESULT >= highlevel),
      Total = n()
    )
  by_Time2 <- dataframe2 %>% 
    group_by(Time) %>% 
    summarize(
      High = sum(RESULT >= highlevel),
      Total = n()
    )
  plot.compare <- ggplot() +
    geom_point(
      data = by_Time1, 
      aes(x = Time, y = High/Total, fill = Total), 
      color = "black", pch = 21, size = 4) +
    scale_fill_gradient(low = "#fbdcbc", high = "#832a00") +
    labs(fill = "2022 Total") +
    new_scale_fill() +
    geom_point(
      data = by_Time2, 
      aes(x = Time, y = High/Total, fill = Total), 
      color = "black", pch = 21, size = 4) +
    scale_fill_gradient(low = "#cae5ee", high = "#003648") +
    labs(fill = "2023 Total")
  
  return(plot.compare)
}

high <- 18

Inpt.plot <- highRateComparison(
  filter(df.2022.rmdup.wkday, Location == "Inpatient"),
  filter(df.2023.rmdup.wkday, Location == "Inpatient"),
  highlevel = high) +
  xlab("Time Completed") +
  labs(title = paste0("Proportion of Anion Gap ≥ ", high," by Time Completed, Inpatient (weekdays)")) 

Emerg.plot <- highRateComparison(
  filter(df.2022.rmdup.wkday, Location == "Emergency"),
  filter(df.2023.rmdup.wkday, Location == "Emergency"),
  highlevel = high) +
  xlab("Time Completed") +
  labs(title = paste0("Proportion of Anion Gap ≥ ", high," by Time Completed, Emergency (weekdays)")) 

Outpt.plot <- highRateComparison(
  filter(df.2022.rmdup.wkday, Location == "Outpatient"),
  filter(df.2023.rmdup.wkday, Location == "Outpatient"),
  highlevel = high) +
  xlab("Time Completed") +
  labs(title = paste0("Proportion of Anion Gap ≥ ", high," by Time Completed, Outpatient (weekdays)")) 


Inpt.plot
Emerg.plot
Outpt.plot #Why are there some missing values in plot???
           #Because there were no tests in that time frame in the dataset

by_Time.2022 <- df.2022.rmdup.wkday %>% 
  group_by(Time) %>% 
  summarize(
    Var = var(RESULT),
    Mean = mean(RESULT),
    Min = min(RESULT),
    Max = max(RESULT),
    High = sum(RESULT >= 18),
    Total = n(),
    `High/Total` = High/Total
  ) 

by_Time.2023 <- df.2023.rmdup.wkday %>% 
  group_by(Time) %>% 
  summarize(
    Var = var(RESULT),
    Mean = mean(RESULT),
    Min = min(RESULT),
    Max = max(RESULT),
    High = sum(RESULT >= 18),
    Total = n(),
    `High/Total` = High/Total
  )

HighTotal.plot <- ggplot() +
  geom_point(
    data = by_Time.2022, 
    aes(x = Time, y = High/Total, fill = Total), 
    color = "black", pch = 21, size = 4
    ) +
  scale_fill_gradient(low = "#fbdcbc", high = "#832a00") + 
  labs(fill = "2022 Total") +
  new_scale_fill() +
  geom_point(
    data = by_Time.2023, 
    aes(x = Time, y = High/Total, fill = Total), 
    color = "black", pch = 21, size = 4
    ) +
  scale_fill_gradient(low = "#cae5ee", high = "#003648") +
  labs(fill = "2023 Total") +
  xlab("Time Completed") +
  labs(title = "Proportion of High Anion Gap by Time Completed (weekdays)")
HighTotal.plot

###################################

highRateComparison.InLab <- function(dataframe1, dataframe2, highlevel) {
  
  by_Time1 <- dataframe1 %>% 
    group_by(Time.InLab) %>% 
    summarize(
      High = sum(RESULT >= highlevel),
      Total = n()
    )
  by_Time2 <- dataframe2 %>% 
    group_by(Time.InLab) %>% 
    summarize(
      High = sum(RESULT >= highlevel),
      Total = n()
    )
  plot.compare <- ggplot() +
    geom_point(
      data = by_Time1, 
      aes(x = Time.InLab, y = High/Total, fill = Total), 
      color = "black", pch = 21, size = 4) +
    scale_fill_gradient(low = "#fbdcbc", high = "#832a00") +
    labs(fill = "2022 Total") +
    new_scale_fill() +
    geom_point(
      data = by_Time2, 
      aes(x = Time.InLab, y = High/Total, fill = Total), 
      color = "black", pch = 21, size = 4) +
    scale_fill_gradient(low = "#cae5ee", high = "#003648") +
    labs(fill = "2023 Total") +
    theme_minimal()
  
  return(plot.compare)
}

high.InLab <- 18

Inpt.plot.InLab <- highRateComparison.InLab(
  filter(df.2022.rmdup.wkday.tat, Location == "Inpatient"),
  filter(df.2023.rmdup.wkday.tat, Location == "Inpatient"),
  highlevel = high.InLab) +
  xlab("Time Received") +
  labs(title = paste0("Proportion of Anion Gap ≥ ", high.InLab," by Time Received in Lab, Inpatient (weekdays)")) 

Emerg.plot.InLab <- highRateComparison.InLab(
  filter(df.2022.rmdup.wkday.tat, Location == "Emergency"),
  filter(df.2023.rmdup.wkday.tat, Location == "Emergency"),
  highlevel = high.InLab) +
  xlab("Time Received") +
  labs(title = paste0("Proportion of Anion Gap ≥ ", high.InLab," by Time Received in Lab, Emergency (weekdays)")) 

Outpt.plot.InLab <- highRateComparison.InLab(
  filter(df.2022.rmdup.wkday.tat, Location == "Outpatient"),
  filter(df.2023.rmdup.wkday.tat, Location == "Outpatient"),
  highlevel = high.InLab) +
  xlab("Time Received") +
  labs(title = paste0("Proportion of Anion Gap ≥ ", high.InLab," by Time Received in Lab, Outpatient (weekdays)")) 

Inpt.plot.InLab
Emerg.plot.InLab
Outpt.plot.InLab

by_Time.InLab.2022 <- df.2022.rmdup.wkday.tat %>% 
  group_by(Time.InLab) %>% 
  summarize(
    Var = var(RESULT),
    Mean = mean(RESULT),
    Min = min(RESULT),
    Max = max(RESULT),
    High = sum(RESULT >= high.InLab),
    Total = n(),
    `High/Total` = High/Total
  ) 

by_Time.InLab.2023 <- df.2023.rmdup.wkday.tat %>% 
  group_by(Time.InLab) %>% 
  summarize(
    Var = var(RESULT),
    Mean = mean(RESULT),
    Min = min(RESULT),
    Max = max(RESULT),
    High = sum(RESULT >= high.InLab),
    Total = n(),
    `High/Total` = High/Total
  )

HighTotal.plot.InLab <- ggplot() +
  geom_point(
    data = by_Time.InLab.2022, 
    aes(x = Time.InLab, y = High/Total, fill = Total), 
    color = "black", pch = 21, size = 4
    ) +
  scale_fill_gradient(low = "#fbdcbc", high = "#832a00") + 
  labs(fill = "2022 Total") +
  new_scale_fill() +
  geom_point(
    data = by_Time.InLab.2023, 
    aes(x = Time.InLab, y = High/Total, fill = Total), 
    color = "black", pch = 21, size = 4
    ) +
  scale_fill_gradient(low = "#cae5ee", high = "#003648") +
  labs(fill = "2023 Total") +
  labs(title = paste0("Proportion of Anion Gap ≥ ", high.InLab, " by Time Received in Lab (weekdays)")) +
  xlab("Time Received") +
  theme_minimal()
HighTotal.plot.InLab

plot.2022.location.timein <- ggplot(df.2022.rmdup.wkday.tat, aes(x = as.numeric(Time.InLab))) +
  geom_freqpoly(data = filter(df.2022.rmdup.wkday.tat, Location == "Inpatient"), color = Inpt22, binwidth = 1) +
  geom_freqpoly(data = filter(df.2022.rmdup.wkday.tat, Location == "Emergency"), color = Emrg22, binwidth = 1) +
  geom_freqpoly(data = filter(df.2022.rmdup.wkday.tat, Location == "Outpatient"), color = Otpt22, binwidth = 1) +
  labs(title = "2022 Anion Gap Frequency Plot by Time Received in Lab") +
  theme_minimal() +
  xlab("Time") +
  ylab("Count") +
  scale_x_continuous(breaks = 0:23, limits = c(0, 23), minor_breaks = NULL)

plot.2023.location.timein <- ggplot(df.2023.rmdup.wkday.tat, aes(x = as.numeric(Time.InLab))) +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday.tat, Location == "Inpatient"), color = Inpt23, binwidth = 1) +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday.tat, Location == "Emergency"), color = Emrg23, binwidth = 1) +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday.tat, Location == "Outpatient"), color = Otpt23, binwidth = 1) +
  labs(title = "2023 Anion Gap Frequency Plot by Time Received in Lab") +
  theme_minimal() +
  xlab("Time") +
  ylab("Count") +
  scale_x_continuous(breaks = 0:23, limits = c(0, 23), minor_breaks = NULL)

plot.2022.location.timein +
  annotate("text", x = 14, y = 125, label = "Inpatient", color = Inpt22, fontface = "italic") +
  annotate("text", x = 14, y = 425, label = "Emergency", color = Emrg22, fontface = "italic") +
  annotate("text", x = 14.5, y = 1875, label = "Outpatient", color = Otpt22, fontface = "italic")

plot.2023.location.timein  +
  annotate("text", x = 12, y = 125, label = "Inpatient", color = Inpt23, hjust = 0.5, fontface = "italic") +
  annotate("text", x = 12, y = 400, label = "Emergency", color = Emrg23, hjust = 0.5, fontface = "italic") +
  annotate("text", x = 14, y = 1350, label = "Outpatient", color = Otpt23, hjust = 0.5, fontface = "italic")

plot.2022.location.timein +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday.tat, Location == "Inpatient"), color = Inpt23, binwidth = 1) +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday.tat, Location == "Emergency"), color = Emrg23, binwidth = 1) +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday.tat, Location == "Outpatient"), color = Otpt23, binwidth = 1) +
  labs(title = "2022 and 2023 Anion Gap Frequency Plot by Time Received in Lab") +
  theme_minimal() +
  annotate("text", x = 16, y = 125, label = "Inpatient (22)", color = Inpt22, hjust = 0.5, fontface = "italic") +
  annotate("text", x = 9, y = 0, label = "Emergency (22)", color = Emrg22, hjust = 0, fontface = "italic") +
  annotate("text", x = 11.5, y = 1875, label = "Outpatient (22)", color = Otpt22, fontface = "italic", hjust = 1) +
  annotate("text", x = 5, y = 375, label = "Inpatient (23)", color = Inpt23, fontface = "italic") +
  annotate("text", x = 13, y = 450, label = "Emergency (23)", color = Emrg23, fontface = "italic") +
  annotate("text", x = 10.5, y = 1375, label = "Outpatient (23)", color = Otpt23, hjust = 1, fontface = "italic")


```

### Sensitivity Analysis

```{r, echo = FALSE}
sens.range <- 16:22

sens.df <- data.frame(Time = str_pad(00:23, 2, side = "left", pad = "0"))
for (i in 1:length(sens.range)) {
  col_name <- paste0("Level", sens.range[i])

  by_Time.2022.sens <- df.2022.rmdup.wkday %>% 
    group_by(Time) %>% 
    summarize(
      Total = n(),
      High = sum(RESULT >= sens.range[i]),
      HighRate = High / Total
    )
  by_Time.2023.sens <- df.2023.rmdup.wkday %>% 
    group_by(Time) %>% 
    summarize(
      Total = n(),
      High = sum(RESULT >= sens.range[i]),
      HighRate = High/Total
    )
  sens.df <- sens.df %>% 
    mutate(
      !!col_name := (by_Time.2022.sens[["HighRate"]] - by_Time.2023.sens[["HighRate"]])
    )
  }

ggplot(data = sens.df, aes(x = Time)) +
  geom_tile(aes(y = 16, fill = Level16)) +
  geom_tile(aes(y = 17, fill = Level17)) +
  geom_tile(aes(y = 18, fill = Level18)) +
  geom_tile(aes(y = 19, fill = Level19)) +
    geom_tile(aes(y = 20, fill = Level20)) +
    geom_tile(aes(y = 21, fill = Level21)) +
    geom_tile(aes(y = 22, fill = Level22)) +
  scale_fill_gradient(low = "white", high = "#430b4e") +
  scale_y_continuous(n.breaks = 7) +
  ylab("High Value Cut-off") +
  xlab("Time Completed") +
  labs(title = "(2022 - 2023) Difference in Rate of High Values by Time Completed", fill = "") +
  theme_minimal()

##################

# Time received sensitivity analysis
sens.range.rec <- 16:22

sens.df.rec <- data.frame(Time = str_pad(00:23, 2, side = "left", pad = "0"))

for (i in 1:length(sens.range.rec)) {
  col_name <- paste0("Level", sens.range.rec[i])
  
  by_Time.2022.sens.rec <- df.2022.rmdup.wkday.tat %>% 
    group_by(Time.InLab) %>% 
    summarize(
      Total = n(),
      High = sum(RESULT >= sens.range.rec[i]),
      HighRate = High / Total
    )
  by_Time.2023.sens.rec <- df.2023.rmdup.wkday.tat %>% 
    group_by(Time.InLab) %>% 
    summarize(
      Total = n(),
      High = sum(RESULT >= sens.range.rec[i]),
      HighRate = High/Total
    )
  sens.df.rec <- sens.df.rec %>% 
    mutate(
      !!col_name := (by_Time.2022.sens.rec[["HighRate"]] - by_Time.2023.sens.rec[["HighRate"]])
    )
  }

ggplot(data = sens.df.rec, aes(x = Time)) +
  geom_tile(aes(y = 16, fill = Level16)) +
  geom_tile(aes(y = 17, fill = Level17)) +
  geom_tile(aes(y = 18, fill = Level18)) +
  geom_tile(aes(y = 19, fill = Level19)) +
    geom_tile(aes(y = 20, fill = Level20)) +
    geom_tile(aes(y = 21, fill = Level21)) +
    geom_tile(aes(y = 22, fill = Level22)) +
  scale_fill_gradient(low = "white", high = "#430b4e") +
  scale_y_continuous(n.breaks = 7) +
  ylab("High Value Cut-off") +
  xlab("Time Received") +
  labs(title = "(2022 - 2023) Difference in Rate of High Values by Time Received", fill = "") +
  theme_minimal()

```

## 6. Turnaround Time Analysis

```{r, echo = FALSE}

ggplot(df.2022.rmdup.wkday.tat, aes(x = TAT_hrs)) +
  geom_histogram(binwidth = 0.25, color = "black", fill = "red", alpha = 0.5) +
  coord_cartesian(xlim = c(0, 12)) +
  scale_x_continuous(breaks = seq(0, 12, 1), ) +
  ylab("Count") +
  xlab("Turnaround Time (hours)") +
  theme_minimal() +
  geom_histogram(data = df.2023.rmdup.wkday.tat, aes(x = TAT_hrs), color = "black", fill = "blue", alpha = 0.5, binwidth = 0.25) +
  annotate("text", x = 1, y = 6000, label = "2022", color = "red", alpha = 0.5, hjust = 0, fontface = "italic") +
  annotate("text", x = 0.75, y = 10500, label = "2023", color = "blue", alpha = 0.5, hjust = 0, fontface = "italic") +
  labs(title = "2022 vs. 2023 Histogram of AG Turnaround Time")

ggplot(df.2022.rmdup.wkday.tat, aes(x = TAT_hrs, group = Location, color = Location)) +
  geom_density() +
  scale_color_manual(values = c("Inpatient" = Inpt22, "Emergency" = Emrg22, "Outpatient" = Otpt22)) +
  coord_cartesian(xlim = c(0.5, 12)) +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_x_continuous(breaks = 0:12) +
  ylab("Density") +
  xlab("Turnaround time (hours)") +
  labs(title = "2022 Turnaround Time Density Plot by Location") +
  annotate("text", x = 1.2, y = 1.0, label = "Inpatient", color = Inpt22, fontface = "italic", hjust = 0) +
  annotate("text", x = 1.0, y = 1.3, label = "Emergency", color = Emrg22, fontface = "italic", hjust = 0) +
  annotate("text", x = 2.2, y = 0.25, label = "Outpatient", color = Otpt22, fontface = "italic", hjust = 0)

ggplot(df.2023.rmdup.wkday.tat, aes(x = TAT_hrs, group = Location, color = Location)) +
  geom_density() +
  scale_color_manual(values = c("Inpatient" = Inpt23, "Emergency" = Emrg23, "Outpatient" = Otpt23)) +
  coord_cartesian(xlim = c(0.5, 12)) +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_x_continuous(breaks = 0:12) +
  ylab("Density") +
  xlab("Turnaround time (hours)") +
  labs(title = "2023 Turnaround Time Density Plot by Location") +
  annotate("text", x = 1.5, y = 0.5, label = "Inpatient", color = Inpt23, fontface = "italic", hjust = 0) +
  annotate("text", x = 1.0, y = 3.5, label = "Emergency", color = Emrg23, fontface = "italic", hjust = 0) +
  annotate("text", x = 1.0, y = 2.0, label = "Outpatient", color = Otpt23, fontface = "italic", hjust = 0)


```

```{r, echo = FALSE}

ggplot(df.2022.rmdup.wkday.tat, aes(x = Time)) +
  geom_boxplot(aes(y = TAT_hrs)) +
  coord_cartesian(ylim = c(0, 12)) +
  scale_y_continuous(breaks = seq(0, 12, 2)) +
  theme_minimal() +
  labs(title = "2022 Anion Gap Turnaround Time vs Time Completed",
       subtitle = "105 points with TAT > 12 hrs not shown") +
  xlab("Time Completed") +
  ylab("Turnaround Time (hrs)")

ggplot(df.2022.rmdup.wkday.tat, aes(x = Time.InLab, group = Time.InLab)) +
  geom_boxplot(aes(y = TAT_hrs)) +
  coord_cartesian(ylim = c(0, 12)) +
  scale_y_continuous(breaks = seq(0, 12, 2)) +
  theme_minimal() +
  labs(title = "2022 Anion Gap Turnaround Time vs Time Received",
       subtitle = "105 points with TAT > 12 hrs not shown") +
  xlab("Time Received") +
  ylab("Turnaround Time (hrs)")
```

Box-and-whisker plot notes: 
The median is shown by a line in the middle of the box.
The lower and upper hinges correspond to the first and third quartiles (the 25th and 75th percentiles). The whiskers extend from the hinge to the smallest and largest values no further than 1.5 * IQR (inter-quartile range) from the hinge.

```{r, echo = FALSE}
ggplot(df.2023.rmdup.wkday.tat, aes(x = Time)) +
  geom_boxplot(aes(y = TAT_hrs)) +
  coord_cartesian(ylim = c(0, 12)) +
  scale_y_continuous(breaks = seq(0, 12, 2)) +
  theme_minimal() +
  labs(title = "2023 Anion Gap Turnaround Time vs Time Completed",
       subtitle = "14 points with TAT > 12 hrs not shown") +
  xlab("Time Completed") +
  ylab("Turnaround Time (hrs)")

ggplot(df.2023.rmdup.wkday.tat, aes(x = Time.InLab, group = Time.InLab)) +
  geom_boxplot(aes(y = TAT_hrs)) +
  coord_cartesian(ylim = c(0, 12)) +
  scale_y_continuous(breaks = seq(0, 12, 2)) +
  theme_minimal() +
  labs(title = "2023 Anion Gap Turnaround Time vs Time Received",
       subtitle = "14 points with TAT > 12 hrs not shown") +
  xlab("Time Received") +
  ylab("Turnaround Time (hrs)")

ggplot(df.2022.rmdup.wkday.tat, aes(x = TAT_hrs, y = factor(as.integer(Time.InLab), levels = 23:0))) +
  geom_density_ridges() +
  coord_cartesian(xlim = c(0, 12)) +
  scale_x_continuous(breaks = 0:12) +
  labs(title = "2022 Turnaround Time Density by Time Received in Lab") +
  ylab("Time Received in Lab")

ggplot(df.2023.rmdup.wkday.tat, aes(x = TAT_hrs, y = factor(as.integer(Time.InLab), levels = 23:0))) +
  geom_density_ridges() +
  coord_cartesian(xlim = c(0, 12)) +
  scale_x_continuous(breaks = 0:12) +
  labs(title = "2023 Turnaround Time Density by Time Received in Lab") +
  ylab("Time Received in Lab")

by_TAT.2022 <- df.2022.rmdup.wkday.tat %>% 
  mutate(
    TAT.bin = cut(TAT_hrs, breaks = seq(0, 12, by = 0.25), labels = seq(0.25, 12, by = 0.25))
  ) %>% 
  group_by(TAT.bin) %>% 
  summarize(
    High = sum(RESULT >= high.InLab),
    Total = n(),
    `High/Total` = High/Total
  )

by_TAT.2023 <- df.2023.rmdup.wkday.tat %>% 
  mutate(
    TAT.bin = cut(TAT_hrs, breaks = seq(0, 12, by = 0.25), labels = seq(0.25, 12, by = 0.25))
  ) %>% 
  group_by(TAT.bin) %>% 
  summarize(
    High = sum(RESULT >= high.InLab),
    Total = n(),
    `High/Total` = High/Total
  )

HighTotal.TAT.plot <- ggplot() +
  geom_point(
    data = by_TAT.2022, 
    aes(x = TAT.bin, y = High/Total, fill = Total), 
    color = "black", pch = 21, size = 4
    ) +
  scale_fill_gradient(low = "#fbdcbc", high = "#832a00") + 
  labs(fill = "2022 Total") +
  new_scale_fill() +
  geom_point(
    data = by_TAT.2023, 
    aes(x = TAT.bin, y = High/Total, fill = Total), 
    color = "black", pch = 21, size = 4
    ) + 
  scale_fill_gradient(low = "#cae5ee", high = "#003648") +
  labs(fill = "2023 Total") +
  labs(title = paste0("Proportion of Anion Gap ≥ ", high.InLab, " by Turnaround Time (weekdays)")) +
  theme_minimal() +
  scale_x_discrete(
    breaks = seq(0, 12, by = 0.25), 
    labels = c("0", "", "0.5", "", "1", "", "1.5", "", "2", "", "2.5", "", "3", "", "3.5", "", "4", "", "4.5", "", "5", "", "5.5", "", "6", "", "6.5", "", "7", "", "7.5", "", "8", "", "8.5", "", "9", "", "9.5", "", "10", "", "10.5", "", "11", "", "11.5", "", "12")) +
  coord_cartesian(xlim = c(0, 25), ylim = c(0, 0.5)) +
  xlab("Turnaround Time (hours)")
  # theme(axis.text.x = element_text(angle = 45))
HighTotal.TAT.plot

ggplot(df.2022.rmdup.wkday.tat, aes(x = TAT_hrs, y = RESULT, color = factor(Time.InLab))) +
  geom_point() +
  coord_cartesian(xlim = c(0, 12), ylim = c(0,45)) +
  scale_color_viridis_d(name = "Legend") +
  scale_x_continuous(breaks = 0:23) +
  labs(title = "2022 Anion Gap Turnaround Time vs. Result") +
  xlab("Turnaround Time (hours)")

ggplot(df.2022.rmdup.wkday.tat, aes(x = RESULT, y = TAT_hrs, color = factor(Time.InLab))) +
  geom_point() +
  coord_cartesian(xlim = c(0, 45), ylim = c(0, 12)) +
  scale_color_viridis_d(name = "Legend") +
  scale_y_continuous(breaks = 0:12) +
  labs(title = "2022 Anion Gap Turnaround Time vs. Result (All Data)") +
  xlab("RESULT") +
  ylab("Turnaround Time (hours)")

####### UPDATE this block to include Creatinine filter (exclude anyone with "H" in cr_NORM), then re-run logistic / linear 
####### regressions and see if that changes results
df.2022.rmdup.wkday.tat.otpt <- df.2022.rmdup.wkday.tat %>% 
  filter(Location == "Outpatient") %>% 
  mutate(
    RESULT.16 = as.integer(RESULT >= 16),
    RESULT.18 = as.integer(RESULT >= 18),
    RESULT.20 = as.integer(RESULT >= 20)
  )

summary(
  glm(
    RESULT.16 ~ TAT_hrs, 
    data = filter(df.2022.rmdup.wkday.tat.otpt, TAT_hrs <= 1), 
    family = "binomial"
    )
  )
summary(
  glm(
    RESULT.16 ~ TAT_hrs, 
    data = filter(df.2022.rmdup.wkday.tat.otpt, TAT_hrs <= 2), 
    family = "binomial"
    )
  )
summary(
  glm(
    RESULT.16 ~ TAT_hrs, 
    data = filter(df.2022.rmdup.wkday.tat.otpt, TAT_hrs <= 3), 
    family = "binomial"
    )
  )
summary(
  glm(
    RESULT.16 ~ TAT_hrs, 
    data = filter(df.2022.rmdup.wkday.tat.otpt, TAT_hrs <= 4), 
    family = "binomial"
    )
  )

df.2023.rmdup.wkday.tat.otpt <- df.2023.rmdup.wkday.tat %>% 
  filter(Location == "Outpatient") %>% 
  mutate(
    RESULT.16 = as.integer(RESULT >= 16),
    RESULT.18 = as.integer(RESULT >= 18),
    RESULT.20 = as.integer(RESULT >= 20)
  )

summary(
  glm(
    RESULT.16 ~ TAT_hrs, 
    data = filter(df.2023.rmdup.wkday.tat.otpt, TAT_hrs <= 1), 
    family = "binomial"
    )
  )
summary(
  glm(
    RESULT.16 ~ TAT_hrs, 
    data = filter(df.2023.rmdup.wkday.tat.otpt, TAT_hrs <= 2), 
    family = "binomial"
    )
  )
summary(
  glm(
    RESULT.16 ~ TAT_hrs, 
    data = filter(df.2023.rmdup.wkday.tat.otpt, TAT_hrs <= 3), 
    family = "binomial"
    )
  )
summary(
  glm(
    RESULT.16 ~ TAT_hrs, 
    data = filter(df.2023.rmdup.wkday.tat.otpt, TAT_hrs <= 4), 
    family = "binomial"
    )
  )

summary(lm(RESULT ~ TAT_hrs, data = filter(df.2022.rmdup.wkday.tat.otpt, TAT_hrs <= 1)))
summary(lm(RESULT ~ TAT_hrs, data = filter(df.2022.rmdup.wkday.tat.otpt, TAT_hrs <= 2)))
summary(lm(RESULT ~ TAT_hrs, data = filter(df.2022.rmdup.wkday.tat.otpt, TAT_hrs <= 3)))
summary(lm(RESULT ~ TAT_hrs, data = filter(df.2022.rmdup.wkday.tat.otpt, TAT_hrs <= 4)))


df.2023.rmdup.wkday.tat.otpt <- df.2023.rmdup.wkday.tat %>% 
  filter(Location == "Outpatient")
summary(lm(RESULT ~ TAT_hrs, data = filter(df.2023.rmdup.wkday.tat.otpt, TAT_hrs <= 1)))
summary(lm(RESULT ~ TAT_hrs, data = filter(df.2023.rmdup.wkday.tat.otpt, TAT_hrs <= 2)))
summary(lm(RESULT ~ TAT_hrs, data = filter(df.2023.rmdup.wkday.tat.otpt, TAT_hrs <= 3)))
summary(lm(RESULT ~ TAT_hrs, data = filter(df.2023.rmdup.wkday.tat.otpt, TAT_hrs <= 4)))

ggplot(filter(df.2022.rmdup.wkday.tat, TAT_hrs <= TAT.cutoff), aes(x = RESULT, y = TAT_hrs, color = factor(Time.InLab))) +
  

ggplot(df.2023.rmdup.wkday.tat, aes(x = RESULT, y = TAT_hrs, color = factor(Time.InLab))) +
  geom_point() +
  coord_cartesian(xlim = c(0, 45), ylim = c(0, 12)) +
  scale_color_viridis_d(name = "Legend") +
  scale_y_continuous(breaks = 0:12) +
  labs(title = "2023 Anion Gap Turnaround Time vs. Result") +
  xlab("RESULT") +
  ylab("Turnaround Time (hours)")

summary(lm(RESULT ~ TAT_hrs, data = df.2022.rmdup.wkday.tat))

summary(lm(RESULT ~ TAT_hrs, data = df.2023.rmdup.wkday.tat))

ggplot(df.2022.rmdup.wkday.tat, aes(x = TAT_hrs, y = RESULT)) +
  geom_point() +
  geom_smooth(method = "lm") +
  xlab("Turnaround Time (hours)") +
  labs(title = "2022 Anion Gap vs Turnaround Time with Linear Regression")

ggplot(df.2023.rmdup.wkday.tat, aes(x = TAT_hrs, y = RESULT)) +
  geom_point() +
  geom_smooth(method = "lm") +
  xlab("Turnaround Time (hours)") +
  labs(title = "2023 Anion Gap vs Turnaround Time with Linear Regression")

```

## 7. Anion Gap Testing by Day

```{r, echo = FALSE}
SVCRSC.byDateTime.2022 <- df.2022.rmdup.wkday.tat %>% 
  group_by(Date, Time, SVCRSC) %>% 
  summarize(n = n())

ggplot(data = SVCRSC.byDateTime.2022, aes(x = Time, y = Date, fill = n)) +
  geom_tile(data = filter(SVCRSC.byDateTime.2022, SVCRSC == "U C1C702")) +
  theme_minimal() +
  labs(title = "2022 | Cobas Unit 1 Anion Gap Usage by Time Completed")

ggplot(data = SVCRSC.byDateTime.2022, aes(x = Time, y = Date, fill = n)) +
  geom_tile(data = filter(SVCRSC.byDateTime.2022, SVCRSC == "U C2C702")) +
  theme_minimal() +
  labs(title = "2022 | Cobas Unit 2 Anion Gap Usage by Time Completed")

ggplot(data = SVCRSC.byDateTime.2022, aes(x = Time, y = Date, fill = n)) +
  geom_tile(data = filter(SVCRSC.byDateTime.2022, SVCRSC == "U C2C702"), width = 0.4, position = position_nudge(x = 0.2), aes(fill = n)) +
  scale_fill_gradient(low = "#832a00", high = "#fbbc7d", name = "Unit 2") +
  new_scale_fill() +
  geom_tile(data = filter(SVCRSC.byDateTime.2022, SVCRSC == "U C1C702"), width = 0.4, position = position_nudge(x = -0.2), aes(fill = n)) +
  scale_fill_gradient(low = "#430b4e", high = "#d3a9ce", name = "Unit 1") +
  theme_minimal() +
  labs(title = "2022 | Cobas Unit Anion Gap Usage by Time Completed")

SVCRSC.byDateTime.2023 <- df.2023.rmdup.wkday.tat %>% 
  group_by(Date, Time, SVCRSC) %>% 
  summarize(n = n())
  
ggplot(data = SVCRSC.byDateTime.2023, aes(x = Time, y = Date, fill = n)) +
  geom_tile(data = filter(SVCRSC.byDateTime.2023, SVCRSC == "UC3C702")) +
  theme_minimal() +
  labs(title = "2023 | Cobas Unit 3 Anion Gap Usage by Time Completed")

ggplot(data = SVCRSC.byDateTime.2023, aes(x = Time, y = Date, fill = n)) +
  geom_tile(data = filter(SVCRSC.byDateTime.2023, SVCRSC == "UC4C702")) +
  theme_minimal() +
  labs(title = "2023 | Cobas Unit 4 Anion Gap Usage by Time Completed")

ggplot(data = SVCRSC.byDateTime.2023, aes(x = Time, y = Date, fill = n)) +
  geom_tile(data = filter(SVCRSC.byDateTime.2023, SVCRSC == "UC5C702")) +
  theme_minimal() +
  labs(title = "2023 | Cobas Unit 5 Anion Gap Usage by Time Completed")



by_Date.2022 <- df.2022.rmdup %>% 
  group_by(Date) %>% 
  summarize(
    Day = first(DayOfWeek),
    Line1 = sum(SVCRSC == "U C1C702"),
    Line2 = sum(SVCRSC == "U C2C702"),
    Total = n()
  )

by_Date.2023 <- df.2023.rmdup %>% 
  group_by(Date) %>% 
  summarize(
    Day = first(DayOfWeek),
    Line3 = sum(SVCRSC == "UC3C702"),
    Line4 = sum(SVCRSC == "UC4C702"),
    Line5 = sum(SVCRSC == "UC5C702"),
    Total = n()
  )

ggplot(df.2022.rmdup, aes(x = Date)) +
  geom_bar() +
  labs(title = "2022 Anion Gap Testing by Day")

ggplot(df.2023.rmdup, aes(x = Date)) +
  geom_bar() +
  labs(title = "2023 Anion Gap Testing by Day")

# ggplot(df.2022.rmdup, aes(x = Date)) +
#   geom_line(aes(y = sum(SVCRSC == "U C1C702"))) +
#   geom_line(aes(y = sum(SVCRSC == "U C2C702"))) +
#   labs(title = "2022 Anion Gap Testing by Day")

by_Date.2022 %>% print(n = 50) %>% kable()
by_Date.2023 %>% print(n = 50) %>% kable()


```
