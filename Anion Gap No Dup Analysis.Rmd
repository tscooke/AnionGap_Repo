---
title: "Anion Gap No Dup Analysis"
author: "Tyler Cooke"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## 1. Import data

```{r, echo = FALSE}
library(tidyverse)
library(knitr)
library(ggthemes)
library(ggnewscale)

setwd(paste0(getwd(), "/.."))
csv2022 <- read.csv(paste0(
  getwd(), "/00. Data/02. Combined Data/AGAP_0612-082022.csv"
))
csv2023 <- read.csv(paste0(
  getwd(), "/00. Data/02. Combined Data/AGAP_0611-081923.csv"
))
tat2022 <- read.csv(paste0(
  getwd(), "/00. Data/02. Combined Data/TAT_0612-082022.csv"
))
tat2023 <- read.csv(paste0(
  getwd(), "/00. Data/02. Combined Data/TAT_0611-081923.csv"
))

```

## 2. Clean data, add Location and prePost variables

-   Filter patient location for Emergency, Inpatient, and Outpatient (including "Private Ambulatory")
-   Add Time, Date, and DayOfWeek variables (extracted from PERFORM_DT_TM)

```{r, echo = FALSE}
clean.csv <- function(dataframe) {
  names(dataframe) <- str_replace_all(names(dataframe), "X_", "")
  dataframe$RESULT <- str_trim(dataframe$RESULT, side = "left") %>% 
    as.numeric()
  dataframe <- dataframe %>% 
    filter(!is.na(RESULT)) %>% 
    filter(str_ends(SVCRSC, "C702")) %>% 
    filter(!(CAT == ".BMPP" | CAT == ".CMPP")) %>% 
    filter(ENCTYP == 'Inpatient' |
             ENCTYP == 'Outpatient' |
             ENCTYP == 'Emergency' |
             ENCTYP == 'Private Ambulatory'
    ) %>%
  mutate(
    Location = case_when(
      ENCTYP == 'Inpatient' ~ 'Inpatient',
      ENCTYP == 'Outpatient' ~ 'Outpatient',
      ENCTYP == 'Emergency' ~ 'Emergency',
      ENCTYP == 'Private Ambulatory' ~ 'Outpatient',
    )
  )
  dataframe$Location <- factor(dataframe$Location,
                                levels = c('Outpatient','Emergency','Inpatient'))
  
  return(dataframe)
}

clean.tat <- function(dataframe) {
  names(dataframe) <- str_replace_all(names(dataframe), "\\.\\.\\.", "")
  dataframe <- dataframe %>% 
    filter(
      Accession.NbrFormatted != "---",
      Order.Status == "Completed"
    ) %>% 
    mutate(
      ACC = str_trim(Accession.NbrFormatted, side = "right"),
      Date.TimeOrder = mdy_hm(str_remove_all(Date.TimeOrder, ",")),
      Date.TimeReq.Coll = mdy_hm(str_remove_all(Date.TimeReq.Coll, ",'")),
      Date.TimeDrawn = mdy_hm(str_remove_all(Date.TimeDrawn, ",'")),
      Date.TimeIn.Lab = mdy_hm(str_remove_all(Date.TimeIn.Lab, ",'")),
      Date.TimeComplete = mdy_hm(str_remove_all(Date.TimeComplete, ",'")),
    )
  return(dataframe)
}

df.2022 <- clean.csv(csv2022)
df.2023 <- clean.csv(csv2023)

tat.2022 <- clean.tat(tat2022)
tat.2023 <- clean.tat(tat2023)

days <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")
dates.2022 <- str_sub(df.2022$PERFORM_DT_TM, start = 1, end = 8)
dates.2022 <- dates.2022[!duplicated(dates.2022)]
dateday.2022 <- data.frame(dates.2022, rep(days, length.out = length(dates.2022)))

dates.2023 <- str_sub(df.2023$PERFORM_DT_TM, start = 1, end = 8)
dates.2023 <- dates.2023[!duplicated(dates.2023)]
dateday.2023 <- data.frame(dates.2023, rep(days, length.out = length(dates.2023)))

df.2022 <- df.2022 %>% 
  mutate(
    DayOfWeek = factor(
      dateday.2022[match(str_sub(PERFORM_DT_TM, start = 1, end = 8),
                                   dateday.2022[,1]),2],
      levels = days
      ),
    Time = str_sub(PERFORM_DT_TM, start = 10, end = 11),
    Date = str_sub(PERFORM_DT_TM, start = 1, end = 8)
  )
  

df.2023 <- df.2023 %>% 
  mutate(
    DayOfWeek = factor(
      dateday.2023[match(str_sub(PERFORM_DT_TM, start = 1, end = 8),
                                   dateday.2023[,1]),2],
      levels = days
      ),
    Time = str_sub(PERFORM_DT_TM, start = 10, end = 11),
    Date = str_sub(PERFORM_DT_TM, start = 1, end = 8)
  )

df.2022.rmdup <- df.2022[!duplicated(df.2022$MRN),]
df.2022.rmdup <- df.2022.rmdup[(df.2022.rmdup$ACC %in% tat.2022$ACC),]

df.2023.rmdup <- df.2023[!duplicated(df.2023$MRN),]
df.2023.rmdup <- df.2023.rmdup[(df.2023.rmdup$ACC %in% tat.2023$ACC),]

df.2022.rmdup.wkday <- df.2022.rmdup %>% filter((DayOfWeek != "Saturday") & (DayOfWeek != "Sunday")) 
df.2023.rmdup.wkday <- df.2023.rmdup %>% filter((DayOfWeek != "Saturday") & (DayOfWeek != "Sunday"))
```

## 3. Descriptive Statistics

```{r}
descStats <- function(dataframe, title) {
  summaryFunc <- function(dataframe) {
    return(c(
      sapply(
        c(
          length(dataframe$RESULT),
          median(dataframe$RESULT),
          round(mean(dataframe$RESULT), 2),
          round(sd(dataframe$RESULT), 2)
        ),
        as.character
      ),
      paste0(
        as.character(range(dataframe$RESULT))[1],
        " to ",
        as.character(range(dataframe$RESULT))[2]
      )
    ))
  }
  
  output <- data.frame(
    summaryFunc(dataframe),
    summaryFunc(filter(dataframe, Location == "Inpatient")),
    summaryFunc(filter(dataframe, Location == "Emergency")),
    summaryFunc(filter(dataframe, Location == "Outpatient")),
    row.names = c("n", "Median", "Mean", "Std. dev.", "Range")
  )
  names(output) <- c("Overall", "Inpatient", "Emergency", "Outpatient")
  return(output)
}

ds.2022 <- descStats(df.2022.rmdup, "Descriptive Statistics, 2022 data")
ds.2023 <- descStats(df.2023.rmdup, "Descriptive Statistics, 2023 data")

kable(ds.2022)
kable(ds.2023)
```

## 4. Density Plots

```{r}
plot.2022 <- ggplot(df.2022.rmdup.wkday, aes(x = RESULT)) +
  geom_freqpoly(
    color = "red",
    binwidth = 1) +
  labs(title = "Anion Gap Frequency Plot (weekdays)")

overlay.plot <- plot.2022 + 
  geom_freqpoly(
    data = df.2023.rmdup.wkday,
    color = "blue",
    binwidth = 1) +
  annotate("text", x = 30, y = 5000,label = "Red = 2022", color = "red") +
  annotate("text", x = 30, y = 4700, label = "Blue = 2023", color = "blue")
overlay.plot

# Inpt22 <- "#fd974f"
# Emrg22 <- "#d61800"
# Otpt22 <- "#7f152e"
# Inpt23 <- "#4cb5f5"
# Emrg23 <- "#337bae"
# Otpt23 <- "#1a405f"
Inpt22 <- "#e9a0a5"
Emrg22 <- "#c5373d"
Otpt22 <- "#730c0d"
Inpt23 <- "#9bcae9"
Emrg23 <- "#006eae"
Otpt23 <- "#002359"

plot.2022.location <- ggplot(df.2022.rmdup.wkday, aes(x = RESULT)) +
  geom_freqpoly(data = filter(df.2022.rmdup.wkday, Location == "Inpatient"), color = Inpt22, binwidth = 1) +
  geom_freqpoly(data = filter(df.2022.rmdup.wkday, Location == "Emergency"), color = Emrg22, binwidth = 1) +
  geom_freqpoly(data = filter(df.2022.rmdup.wkday, Location == "Outpatient"), color = Otpt22, binwidth = 1) +
  labs(title = "2022 Anion Gap Frequency Plot by Location (weekdays)") +
  theme_minimal()
plot.2022.location +
  annotate(
    "text", x = 30, y = 1500, hjust = 0, lineheight = 1.8,
    label = c("Legend", "\nInpatient", "\n\nEmergency", "\n\n\nOutpatient"),
    color = c("black", Inpt22, Emrg22, Otpt22),
    fontface = c("bold", "plain", "plain", "plain"))

plot.2023.location <- ggplot(df.2023.rmdup.wkday, aes(x = RESULT)) +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday, Location == "Inpatient"), color = Inpt23, binwidth = 1) +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday, Location == "Emergency"), color = Emrg23, binwidth = 1) +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday, Location == "Outpatient"), color = Otpt23, binwidth = 1) +
  labs(title = "2023 Anion Gap Frequency Plot by Location (weekdays)") +
  theme_minimal()
plot.2023.location  +
    annotate(
    "text", x = 30, y = 1500, hjust = 0, lineheight = 1.8,
    label = c("Legend", "\nInpatient", "\n\nEmergency", "\n\n\nOutpatient"),
    color = c("black", Inpt23, Emrg23, Otpt23),
    fontface = c("bold", "plain", "plain", "plain"))

location.overlay <- plot.2022.location + 
    geom_freqpoly(data = filter(df.2023.rmdup.wkday, Location == "Inpatient"), color = Inpt23, binwidth = 1) +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday, Location == "Emergency"), color = Emrg23, binwidth = 1) +
  geom_freqpoly(data = filter(df.2023.rmdup.wkday, Location == "Outpatient"), color = Otpt23, binwidth = 1) + 
  labs(title = "Anion Gap Frequency Plot by Year and Location (weekdays)")
location.overlay +
  annotate(
    "text", x = 30, y = 2750, hjust = 0, lineheight = 1.8,
    label = c("Legend", "\n\n2022", "\n\n\nInpatient", "\n\n\n\nEmergency", "\n\n\n\n\nOutpatient"),
    color = c("black", "black",Inpt22, Emrg22, Otpt22),
    fontface = c("bold", "bold", "plain", "plain", "plain")) +
  annotate(
    "text", x = 30, y = 1500, hjust = 0, lineheight = 1.8,
    label = c("2023", "\nInpatient", "\n\nEmergency", "\n\n\nOutpatient"),
    color = c("black", Inpt23, Emrg23, Otpt23),
    fontface = c("bold", "plain", "plain", "plain"))


dayplot.2022 <- ggplot(df.2022.rmdup, aes(x = DayOfWeek)) +
  geom_bar() +
  labs(title = "2022 Test Count by Day of Week")
print(dayplot.2022)

dayplot.2023 <- ggplot(df.2023.rmdup, aes(x = DayOfWeek)) +
  geom_bar() +
  labs(title = "2023 Test Count by Day of Week")
dayplot.2023

```

## 5. Anion Gap Elevation by Time

```{r, echo = FALSE}
highRateComparison <- function(dataframe1, dataframe2, highlevel) {
  
  by_Time1 <- dataframe1 %>% 
    group_by(Time) %>% 
    summarize(
      High = sum(RESULT >= highlevel),
      Total = n()
    )
  by_Time2 <- dataframe2 %>% 
    group_by(Time) %>% 
    summarize(
      High = sum(RESULT >= highlevel),
      Total = n()
    )
  plot.compare <- ggplot() +
    geom_point(
      data = by_Time1, 
      aes(x = Time, y = High/Total, fill = Total), 
      color = "black", pch = 21, size = 4) +
    scale_fill_gradient(low = "#fbdcbc", high = "#832a00") +
    labs(fill = "2022 Total") +
    new_scale_fill() +
    geom_point(
      data = by_Time2, 
      aes(x = Time, y = High/Total, fill = Total), 
      color = "black", pch = 21, size = 4) +
    scale_fill_gradient(low = "#cae5ee", high = "#003648") +
    labs(fill = "2023 Total")
  
  return(plot.compare)
}

high <- 18
# 
# highRateComparison(df.2022.rmdup.wkday, df.2023.rmdup.wkday, 18) +
#   labs(title = "test title")

Inpt.plot <- highRateComparison(
  filter(df.2022.rmdup.wkday, Location == "Inpatient"),
  filter(df.2023.rmdup.wkday, Location == "Inpatient"),
  highlevel = high) +
  labs(title = paste0("Rate of Anion Gap ≥ ", high," by Hour, Inpatient (weekdays)")) 
# +
#   annotate(
#     "text", x = 12, y = 0.25, lineheight = 1.8, hjust = 0,
#     label = c("Red = 2022", "\nBlue = 2023"), 
#     color = c("red", "blue")
#   )

Emerg.plot <- highRateComparison(
  filter(df.2022.rmdup.wkday, Location == "Emergency"),
  filter(df.2023.rmdup.wkday, Location == "Emergency"),
  highlevel = high) +
  labs(title = paste0("Rate of Anion Gap ≥ ", high," by Hour, Emergency (weekdays)")) 
# +
#   annotate(
#     "text", x = 12, y = 0.25, lineheight = 1.8, hjust = 0,
#     label = c("Red = 2022", "\nBlue = 2023"), 
#     color = c("red", "blue")
#   )

Outpt.plot <- highRateComparison(
  filter(df.2022.rmdup.wkday, Location == "Outpatient"),
  filter(df.2023.rmdup.wkday, Location == "Outpatient"),
  highlevel = high) +
  labs(title = paste0("Rate of Anion Gap ≥ ", high," by Hour, Outpatient (weekdays)")) 
# +
#   annotate(
#     "text", x = 12, y = 0.25, lineheight = 1.8, hjust = 0,
#     label = c("Red = 2022", "\nBlue = 2023"), 
#     color = c("red", "blue")
#   )

Inpt.plot
Emerg.plot
Outpt.plot #Why are there some missing values in plot???
           #Because there were no tests in that time frame in the dataset

by_Time.otpt2023 <- df.2023.rmdup.wkday %>%
  filter(Location == "Outpatient") %>%
  group_by(Time) %>%
  summarize(High = sum(RESULT >= high), Total = n())
# by_Time.otpt2023 # Checking to confirm why there are "missing" points on graph

by_Time.inpt2022 <- df.2022.rmdup.wkday %>% 
  filter(Location == "Inpatient") %>% 
  group_by(Time) %>% 
  summarize(High = sum(RESULT >= high), Total = n())

by_Time.2022 <- df.2022.rmdup.wkday %>% 
  group_by(Time) %>% 
  summarize(
    Var = var(RESULT),
    Mean = mean(RESULT),
    Min = min(RESULT),
    Max = max(RESULT),
    High = sum(RESULT >= 18),
    Total = n(),
    `High/Total` = High/Total
  ) 

by_Time.2023 <- df.2023.rmdup.wkday %>% 
  group_by(Time) %>% 
  summarize(
    Var = var(RESULT),
    Mean = mean(RESULT),
    Min = min(RESULT),
    Max = max(RESULT),
    High = sum(RESULT >= 18),
    Total = n(),
    `High/Total` = High/Total
  )

HighTotal.plot <- ggplot() +
  geom_point(
    data = by_Time.2022, 
    aes(x = Time, y = High/Total, fill = Total), 
    color = "black", pch = 21, size = 4
    ) +
  scale_fill_gradient(low = "#fbdcbc", high = "#832a00") + 
  labs(fill = "2022 Total") +
  new_scale_fill() +
  geom_point(
    data = by_Time.2023, 
    aes(x = Time, y = High/Total, fill = Total), 
    color = "black", pch = 21, size = 4
    ) +
  scale_fill_gradient(low = "#cae5ee", high = "#003648") +
  labs(fill = "2023 Total") +
  # annotate("text", x = 12, y = 0.2,label = "Red = 2022", color = "red") +
  # annotate("text", x = 12, y = 0.19, label = "Blue = 2023", color = "blue") +
  labs(title = "Rate of High Anion Gap by Time of Day (weekdays)") +
  theme_minimal()
HighTotal.plot


# by_Time.2022 %>% print(n=24) %>% kable(caption = "2022 Anion Gap Testing by Hour")
# by_Time.2023 %>% print(n=24) %>% kable(caption = "2023 Anion Gap Testing by Hour")
# 
# # by_Time.2023 %>% filter(Location == "Outpatient") %>% print(n=24)
# 
# ggplot(data = df.2022.rmdup.wkday, aes(x = Time)) +
#   geom_bar(aes(fill = RESULT >= 18)) +
#   scale_fill_manual(values = c("#1b9e77", "#d95f02")) +
#   labs(title = "2022 Number of Tests Run by Hour (weekdays)")
# 
# ggplot(data = df.2023.rmdup.wkday, aes(x = Time)) +
#   geom_bar(aes(fill = RESULT >= 18)) +
#   scale_fill_manual(values = c("#1b9e77", "#d95f02")) +
#   labs(title = "2023 Number of Tests Run by Hour (weekdays)")

```

### Sensitivity Analysis

```{r, echo = FALSE}
sens.range <- 16:22

sens.df <- data.frame(Time = str_pad(00:23, 2, side = "left", pad = "0"))
for (i in 1:length(sens.range)) {
  col_name <- paste0("Level", sens.range[i])
# HighRate_diff <- function(sens.value, sens.df) {
#   i <- sens.value
  by_Time.2022.sens <- df.2022.rmdup.wkday %>% 
    group_by(Time) %>% 
    summarize(
      Total = n(),
      High = sum(RESULT >= sens.range[i]),
      HighRate = High / Total
    )
  by_Time.2023.sens <- df.2023.rmdup.wkday %>% 
    group_by(Time) %>% 
    summarize(
      Total = n(),
      High = sum(RESULT >= sens.range[i]),
      HighRate = High/Total
    )
  sens.df <- sens.df %>% 
    mutate(
      !!col_name := (by_Time.2022.sens[["HighRate"]] - by_Time.2023.sens[["HighRate"]])
    )
  # return(sens.df)
  }

# sens.df <- as.data.frame(t(sens.df))

ggplot(data = sens.df, aes(x = Time)) +
  geom_tile(aes(y = 16, fill = Level16)) +
  geom_tile(aes(y = 17, fill = Level17)) +
  geom_tile(aes(y = 18, fill = Level18)) +
  geom_tile(aes(y = 19, fill = Level19)) +
    geom_tile(aes(y = 20, fill = Level20)) +
    geom_tile(aes(y = 21, fill = Level21)) +
    geom_tile(aes(y = 22, fill = Level22)) +
  scale_fill_gradient(low = "white", high = "#430b4e") +
  scale_y_continuous(n.breaks = 7) +
  ylab("High Value Cut-off")+
  labs(title = "(2022 - 2023) Difference in Rate of High Values", fill = "")+
  theme_minimal()
```

## 6. Relationship Between Turnaround Time and Anion Gap

```{r, echo = FALSE}

#df.2022 and df.2023 are already filtered to only include rows that also have a TAT 

# 1) Add TAT columns to df.2022 and df.2023
# 2) Plot TAT against hour as a box and whisker
# 3) Plot TAT against difference between 2022 AG and 2023 AG -- how would this work?
    # Plot TAT against AG for 2022 and 2023 and do a linear(?) regression - there should be no pattern,
    # but if TAT does predict AG, then we would expect to see a positive trend in 2022 but not 2023.
    # It might be subtle, so try with all the whole range of data first, but also try with only AG ≥ 16
# 4) Update code to use lubridate instead of manually calculating day of the week for df  

tat.2022.rmdup <- tat.2022 %>% 
  arrange(Date.TimeComplete) %>% 
  filter(!duplicated(ACC))

tat.2023.rmdup <- tat.2023 %>% 
  arrange(Date.TimeComplete) %>% 
  filter(!duplicated(ACC))

df.2022.rmdup.wkday.tat <- merge(
  x = df.2022.rmdup.wkday,
  y = tat.2022.rmdup[c("ACC", "Date.TimeOrder", "Date.TimeReq.Coll", "Date.TimeDrawn", "Date.TimeIn.Lab", "Date.TimeComplete")],
  by.x = "ACC",
  by.y = "ACC"
)

df.2023.rmdup.wkday.tat <- merge(
  x = df.2023.rmdup.wkday,
  y = tat.2023.rmdup[c("ACC", "Date.TimeOrder", "Date.TimeReq.Coll", "Date.TimeDrawn", "Date.TimeIn.Lab", "Date.TimeComplete")],
  by.x = "ACC",
  by.y = "ACC"
)

tatAnalysis <- function(dataframe) {
  output <- dataframe %>% 
    mutate(
      TAT = Date.TimeIn.Lab - Date.TimeComplete
    )
}


```

## 7. Anion Gap Testing by Day

```{r, echo = FALSE}
by_Date.2022 <- df.2022.rmdup %>% 
  group_by(Date) %>% 
  summarize(
    Day = first(DayOfWeek),
    Line1 = sum(SVCRSC == "U C1C702"),
    Line2 = sum(SVCRSC == "U C2C702"),
    Total = n()
  )

by_Date.2023 <- df.2023.rmdup %>% 
  group_by(Date) %>% 
  summarize(
    Day = first(DayOfWeek),
    Line3 = sum(SVCRSC == "UC3C702"),
    Line4 = sum(SVCRSC == "UC4C702"),
    Line5 = sum(SVCRSC == "UC5C702"),
    Total = n()
  )

ggplot(df.2022.rmdup, aes(x = Date)) +
  geom_bar() +
  labs(title = "2022 Anion Gap Testing by Day")

ggplot(df.2023.rmdup, aes(x = Date)) +
  geom_bar() +
  labs(title = "2023 Anion Gap Testing by Day")

# ggplot(df.2022.rmdup, aes(x = Date)) +
#   geom_line(aes(y = sum(SVCRSC == "U C1C702"))) +
#   geom_line(aes(y = sum(SVCRSC == "U C2C702"))) +
#   labs(title = "2022 Anion Gap Testing by Day")

by_Date.2022 %>% print(n = 50) %>% kable()
by_Date.2023 %>% print(n = 50) %>% kable()


```
